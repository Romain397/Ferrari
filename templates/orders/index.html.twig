{% extends 'base.html.twig' %}

{% block title %}Mes Commandes
{% endblock %}

{% block page_background %}img/store.jpg{% endblock %}

{% block main %}
	<div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
		<h1 class="mb-0 text-danger">Mes Commandes</h1>
		<a href="{{ path('store') }}" class="btn btn-secondary">Retour au Store</a>
	</div>

	{% if commandes is empty %}
		<div class="alert alert-dark border border-danger">
			Aucune commande pour le moment.
		</div>
	{% else %}
		<div class="table-responsive">
			<table class="table table-striped table-hover align-middle">
				<thead class="table-dark">
					<tr>
						<th>N° commande</th>
						<th>Date</th>
						<th>Total</th>
						<th>Statut</th>
						<th>Détails</th>
						<th class="text-end">Actions</th>
					</tr>
				</thead>
				<tbody>
					{% for commande in commandes %}
						<tr>
							<td>
								<strong class="text-danger">CMD-{{ '%06d'|format(commande.id) }}</strong>
							</td>
							<td>{{ commande.createdAt ? commande.createdAt|date('d/m/Y H:i') : '-' }}</td>
							<td><strong>{{ commande.total|number_format(2, ',', ' ') }} €</strong></td>
							<td>
								{% set badgeClass = commande.status == 'Livrée' ? 'bg-success' : (commande.status == 'Commande annulée' ? 'bg-danger' : (commande.status == 'En livraison' ? 'bg-primary' : 'bg-warning text-dark')) %}
								<span class="badge {{ badgeClass }}">{{ commande.status }}</span>
							</td>
							<td>
								<small class="text-light-emphasis d-block mb-1">{{ commande.items|length }} article(s)</small>
								{% for item in commande.items|slice(0, 2) %}
									<div class="small">
										{{ item.quantity }} x {{ item.name }}
									</div>
								{% endfor %}
								{% if commande.items|length > 2 %}
									<small class="text-light-emphasis">...</small>
								{% endif %}
							</td>
							<td class="text-end">
								<div class="d-inline-flex gap-2">
									{% if commande.status == 'En attente' or commande.status == 'En livraison' %}
										<form method="post" action="{{ path('orders_cancel', {'id': commande.id}) }}" class="d-inline">
											<input type="hidden" name="_token" value="{{ csrf_token('cancel_order_' ~ commande.id) }}">
											<button type="submit" class="btn btn-sm btn-outline-warning">Annuler</button>
										</form>
									{% endif %}

									{% if commande.status == 'Livrée' or commande.status == 'Commande annulée' %}
										<form method="post" action="{{ path('orders_clear', {'id': commande.id}) }}" class="d-inline">
											<input type="hidden" name="_token" value="{{ csrf_token('clear_order_' ~ commande.id) }}">
											<button type="submit" class="btn btn-sm btn-danger" title="Supprimer de la page">✕</button>
										</form>
									{% endif %}
								</div>
							</td>
						</tr>
					{% endfor %}
				</tbody>
			</table>
		</div>
	{% endif %}
{% endblock %}
