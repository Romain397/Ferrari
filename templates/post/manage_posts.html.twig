{% extends 'base.html.twig' %}

{% block title %}G√©rer les articles
{% endblock %}

{% block main %}
	<div class="mb-4">
		<a href="{{ path('dashboard') }}" class="btn btn-secondary">‚Üê Retour au Dashboard</a>
	</div>
	<h1 class="mb-4 text-center text-danger">üì∞ G√©rer les articles de voitures</h1>

	<!-- FORMULAIRE DE CR√âATION/MODIFICATION -->
	<div class="card bg-dark border-danger mb-5 p-4">
		<h3 class="mb-3 text-danger">
			{% if editingPost is defined %}
				‚úèÔ∏è Modifier l'article: <strong>{{ editingPost.title }}</strong>
			{% else %}
				‚ûï Ajouter un nouvel article
			{% endif %}
		</h3>

		{% if form.vars.errors|length > 0 %}
			<div class="alert alert-danger alert-dismissible fade show" role="alert">
				<strong>‚ö†Ô∏è Erreurs de validation:</strong>
				<ul class="mb-0 mt-2">
					{% for error in form.vars.errors %}
						<li>{{ error.message }}</li>
					{% endfor %}
				</ul>
				<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
			</div>
		{% endif %}

		{{ form_start(form, {'attr': {'class': 'needs-validation', 'novalidate': 'novalidate'}}) }}

			<div class="row mb-3">
				<div class="col-md-6">
					{{ form_row(form.title, {'attr': {'class': 'form-control'}}) }}
				</div>
				<div class="col-md-6">
					{{ form_row(form.category, {'attr': {'class': 'form-select'}}) }}
				</div>
			</div>

			<div class="row mb-3">
				<div class="col-md-12">
					{{ form_row(form.content, {'attr': {'class': 'form-control', 'rows': 4}}) }}
				</div>
			</div>

			<!-- CHAMPS POUR VOITURES -->
			<div id="voiture-fields" class="voiture-section">
				<hr class="border-danger my-4">
				<h4 class="text-danger mb-3">üèéÔ∏è Champs pour Voitures</h4>
				
				<div class="row mb-3">
					<div class="col-md-6">
						{{ form_row(form.model, {'attr': {'class': 'form-control'}}) }}
					</div>
					<div class="col-md-6">
						{{ form_row(form.year, {'attr': {'class': 'form-control'}}) }}
					</div>
				</div>

				<div class="row mb-3">
					<div class="col-md-6">
						{{ form_row(form.image, {'attr': {'class': 'form-control'}}) }}
					</div>
					<div class="col-md-6">
						{{ form_row(form.video, {'attr': {'class': 'form-control'}}) }}
					</div>
				</div>

				<div class="row mb-3">
					<div class="col-md-12">
						{{ form_row(form.highlight) }}
					</div>
				</div>
			</div>

			<!-- CHAMPS POUR COURSES -->
			<div id="course-fields" class="course-section">
				<hr class="border-danger my-4">
				<h4 class="text-danger mb-3">üèÅ Champs pour Courses</h4>
				
				<div class="row mb-3">
					<div class="col-md-6">
						{{ form_row(form.circuitImage, {'attr': {'class': 'form-control'}}) }}
					</div>
					<div class="col-md-6">
						{{ form_row(form.raceDate, {'attr': {'class': 'form-control'}}) }}
					</div>
				</div>
			</div>

			<div class="d-flex gap-2 mt-4">
				{% if editingPost is defined %}
					<button type="submit" class="btn btn-success">Mettre √† jour</button>
					<a href="{{ path('manage_posts') }}" class="btn btn-secondary">Annuler</a>
				{% else %}
					<button type="submit" class="btn btn-danger">Publier</button>
				{% endif %}
			</div>

		{{ form_end(form) }}
	</div>

	<script>
		function toggleCategoryFields() {
			const categorySelect = document.querySelector('[name="post[category]"]');
			const voitureFields = document.getElementById('voiture-fields');
			const courseFields = document.getElementById('course-fields');

			function updateDisplay() {
				const selectedValue = categorySelect.value;
				if (selectedValue === 'Voiture') {
					voitureFields.style.display = 'block';
					courseFields.style.display = 'none';
				} else if (selectedValue === 'Course') {
					voitureFields.style.display = 'none';
					courseFields.style.display = 'block';
				}
			}

			updateDisplay();
			categorySelect.addEventListener('change', updateDisplay);
		}

		document.addEventListener('DOMContentLoaded', toggleCategoryFields);
	</script>
	</div>

	<!-- LISTE DES POSTS -->
	<h3 class="mb-3 text-danger">üìö Articles existants</h3>

	{% if posts is not empty %}
		<div class="table-responsive">
			<table class="table table-striped table-hover">
				<thead class="table-dark">
					<tr>
						<th>ID</th>
						<th>Titre</th>
						<th>Mod√®le</th>
						<th>Ann√©e</th>
						<th>Cat√©gorie</th>
						<th>√Ä la une</th>
						<th>Actions</th>
					</tr>
				</thead>
				<tbody>
					{% for post in posts %}
						<tr>
							<td><strong>{{ post.id }}</strong></td>
							<td>{{ post.title }}</td>
							<td>{{ post.model }}</td>
							<td>{{ post.year }}</td>
							<td>
								<span class="badge {% if post.category.value == 'Voiture' %}bg-danger{% else %}bg-warning{% endif %}">
									{{ post.category.value }}
								</span>
							</td>
							<td>
								{% if post.highlight %}
									<span class="badge bg-success">‚≠ê OUI</span>
								{% else %}
									<span class="badge bg-secondary">Non</span>
								{% endif %}
							</td>
							<td>
								<a href="{{ path('edit_post', {'id': post.id}) }}" class="btn btn-sm btn-warning">‚úèÔ∏è Modifier</a>
								<a href="{{ path('delete_post', {'id': post.id}) }}" class="btn btn-sm btn-danger" onclick="return confirm('√ätes-vous s√ªr ?')">üóëÔ∏è Supprimer</a>
							</td>
						</tr>
					{% endfor %}
				</tbody>
			</table>
		</div>
	{% else %}
		<div class="alert alert-info" role="alert">
			Aucun article pour le moment. Cr√©ez le premier ci-dessus !
		</div>
	{% endif %}
{% endblock %}
