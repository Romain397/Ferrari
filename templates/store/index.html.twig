{% extends 'base.html.twig' %}

{% block title %}Store Ferrari | Produits
{% endblock %}

{% block meta_description %}Boutique Ferrari: vetements, accessoires et merchandising officiels, avec filtres par type et prix.
{% endblock %}

{% block page_background %}img/store.jpg{% endblock %}

{% block main %}
	<h1 class="text-danger mb-4">Store</h1>

	<div class="store-filters-bar mb-4">
		<form method="get" action="{{ path('store') }}" class="row g-2 align-items-end">
			<div class="col-12 col-md-5 col-lg-3">
				<label for="filter-q" class="form-label form-label-sm mb-1 text-light">Recherche</label>
				<input
				type="text"
				class="form-control form-control-sm"
				id="filter-q"
				name="q"
				value="{{ filters.q|default('') }}"
				placeholder="Rechercher un produit">
			</div>

			<div class="col-6 col-md-3 col-lg-2">
				<label for="filter-type" class="form-label form-label-sm mb-1 text-light">Type</label>
				<select id="filter-type" name="type" class="form-select form-select-sm">
					<option value="">Tous</option>
					{% for value, label in typeOptions %}
						<option value="{{ value }}" {% if filters.type == value %}selected{% endif %}>{{ label }}</option>
					{% endfor %}
				</select>
			</div>

			<div class="col-6 col-md-2 col-lg-2">
				<label for="filter-min-price" class="form-label form-label-sm mb-1 text-light">Min EUR</label>
				<input type="number" step="0.01" min="0" class="form-control form-control-sm" id="filter-min-price" name="min_price" value="{{ filters.min_price is not null ? filters.min_price : '' }}">
			</div>

			<div class="col-6 col-md-2 col-lg-2">
				<label for="filter-max-price" class="form-label form-label-sm mb-1 text-light">Max EUR</label>
				<input type="number" step="0.01" min="0" class="form-control form-control-sm" id="filter-max-price" name="max_price" value="{{ filters.max_price is not null ? filters.max_price : '' }}">
			</div>

			<div class="col-12 col-md-4 col-lg-3">
				<label for="filter-sort" class="form-label form-label-sm mb-1 text-light">Tri</label>
				<select id="filter-sort" name="sort" class="form-select form-select-sm">
					<option value="recent" {% if filters.sort == 'recent' %}selected{% endif %}>Plus recents</option>
					<option value="oldest" {% if filters.sort == 'oldest' %}selected{% endif %}>Plus anciens</option>
					<option value="price_asc" {% if filters.sort == 'price_asc' %}selected{% endif %}>Prix croissant</option>
					<option value="price_desc" {% if filters.sort == 'price_desc' %}selected{% endif %}>Prix decroissant</option>
					<option value="name_asc" {% if filters.sort == 'name_asc' %}selected{% endif %}>Nom A -> Z</option>
					<option value="name_desc" {% if filters.sort == 'name_desc' %}selected{% endif %}>Nom Z -> A</option>
				</select>
			</div>

			<div class="col-12 d-flex gap-2 flex-wrap align-items-center">
				<button type="submit" class="btn btn-danger btn-sm">Appliquer</button>
				<a href="{{ path('store') }}" class="btn btn-secondary btn-sm">Reset</a>
				<small class="ms-auto align-self-center text-light">
					{{ products|length }} produit(s)
				</small>
			</div>
		</form>
	</div>

	<div class="row g-4 store-layout">
		<div class="col-12 col-xl-8">
			<section aria-labelledby="store-products-heading">
				<h2 id="store-products-heading" class="visually-hidden">Produits du store</h2>
				<div class="row">
					{% for product in products %}
						<div class="col-12 col-sm-6 col-lg-4 mb-4 store-product-col">
							<article class="card h-100 shadow-sm">
								{% if product.image %}
									<img
										src="{{ asset(product.image) }}"
										class="card-img-top store-product-image"
										alt="{{ product.name }}"
										width="640"
										height="640"
										sizes="(min-width: 1200px) 250px, (min-width: 768px) 220px, 90vw"
										loading="{{ loop.first ? 'eager' : 'lazy' }}"
										fetchpriority="{{ loop.first ? 'high' : 'auto' }}"
										decoding="async">
								{% endif %}
								<div class="card-body d-flex flex-column">
									<h3 class="card-title h5 text-warning">{{ product.name }}</h3>
									<div class="flex-grow-1">
										{% set fullDescription = product.description|default('') %}
										{% set collapseId = 'desc-' ~ product.id %}
										{% if fullDescription|length > 90 %}
											{% set shortDescription = fullDescription|slice(0, 90) %}
											{% set remainingDescription = fullDescription|slice(90) %}
											<p class="card-text mb-1">
												{{ shortDescription }}<span class="store-desc-more collapse collapse-inline" id="{{ collapseId }}">{{ remainingDescription }}</span><span class="store-desc-dots">...</span>
												<button
													class="btn store-desc-toggle"
													type="button"
													data-bs-toggle="collapse"
													data-bs-target="#{{ collapseId }}"
													aria-expanded="false"
													aria-controls="{{ collapseId }}"
													aria-label="Afficher plus">
													+
												</button>
											</p>
										{% else %}
											<p class="card-text">{{ fullDescription ?: 'Pas de description' }}</p>
										{% endif %}
									</div>
									<p class="text-light fw-bold mb-3">{{ product.price }} EUR</p>
									<button
										type="button"
										class="btn btn-danger w-100 js-add-to-cart"
										data-product-id="{{ product.id }}"
										data-product-name="{{ product.name }}"
										data-product-price="{{ product.price }}"
										data-product-image="{{ product.image ? asset(product.image) : '' }}">
										Ajouter au panier
									</button>
								</div>
							</article>
						</div>
					{% else %}
						<p>Aucun produit pour le moment.</p>
					{% endfor %}
				</div>
			</section>
		</div>

		<div class="col-12 col-xl-4">
			<div id="store-cart-panel" class="card store-sticky-cart no-lift border border-danger p-3" data-ordered="{{ app.request.query.get('ordered') ? '1' : '0' }}">
				<h2 class="h4 text-danger mb-3">Panier</h2>

				<div id="store-cart-empty" class="alert alert-dark border border-danger mb-0" style="display:none;">
					Votre panier est vide.
				</div>

				<div id="store-cart-content" style="display:none;">
					<div id="store-cart-items" class="d-flex flex-column gap-2"></div>

					<div class="d-flex justify-content-between align-items-center mt-3 flex-wrap gap-2">
						<p class="mb-0 fs-6">
							Total:
							<strong class="text-danger" id="store-cart-total">0.00 EUR</strong>
						</p>
					</div>

					<form method="post" action="{{ path('cart_checkout') }}" id="store-checkout-form" class="checkout-form-inline mt-3">
						<input type="hidden" name="cart_items" id="store-cart-items-input">
						<input type="hidden" name="_token" value="{{ csrf_token('cart_checkout') }}">
						<button type="submit" class="btn btn-danger w-100">Passer la commande</button>
					</form>

					{% if not app.user %}
						<p class="mt-3 mb-0 text-warning small">
							Connexion requise pour commander.
							<a href="{{ path('app_login') }}" class="text-warning">Se connecter</a>
						</p>
					{% endif %}
				</div>
			</div>
		</div>
	</div>
{% endblock %}
